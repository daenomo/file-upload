<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ファイルアップロードのデモ</title>
</head>
<body>

<h2>メディアプレーヤー</h2>
<video id="videoPlayer" width="600" controls>
    <source id="videoSource" src="" type="video/mp4">
    お使いのブラウザはこのビデオタグをサポートしていません。
</video>
<img id="imageDisplay" src="" style="display:none;" width="600"/>

<h2>ファイルアップロードフォーム</h2>
<form enctype="multipart/form-data" action="/upload" method="POST">
    <input type="file" name="file" multiple>
    <input type="submit" value="アップロード">
</form>

<ul id="fileList">
    {{range .}}
    <li>
        <a href="#" onclick="playFile('{{.Name}}'); return false;">{{.Name}}</a>
    </li>
    {{else}}
    <p>No files found.</p>
    {{end}}
</ul>

<script>
    const videoPlayer = document.getElementById('videoPlayer');
    const videoSource = document.getElementById('videoSource');
    const imageDisplay = document.getElementById('imageDisplay');
    const fileList = document.getElementById('fileList');
    let currentFileName = "";
    let fileChangeTimeout;

    function fetchFileList() {
        fetch('/file-list')
            .then(response => response.json())
            .then(data => {
                updateFileList(data);
            })
            .catch(error => console.error('Error fetching file list:', error));
    }

    function updateFileList(files) {
        fileList.innerHTML = ''; 
        if (files.length === 0) {
            fileList.innerHTML = '<p>No files found.</p>';
        } else {
            files.forEach(file => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = file.Name;
                a.onclick = () => {
                    playFile(file.Name);
                    return false;
                };
                li.appendChild(a);
                fileList.appendChild(li);
            });
        }
    }

    function playFile(fileName) {
        clearTimeout(fileChangeTimeout);
        currentFileName = fileName;
        const extension = fileName.split('.').pop().toLowerCase();
        const src = `/videos/${fileName}`;

        if (extension === 'mp4') {
            videoPlayer.style.display = 'block';
            imageDisplay.style.display = 'none';
            videoSource.src = src;
            videoPlayer.load();
            videoPlayer.play();
            videoPlayer.addEventListener('ended', playNextFile);
        } else if (extension === 'jpg' || extension === 'jpeg' || extension === 'png') {
            videoPlayer.style.display = 'none';
            imageDisplay.style.display = 'block';
            imageDisplay.src = src;
            fileChangeTimeout = setTimeout(playNextFile, 10000);  // 10秒後に次のファイルを再生
        }
    }

    function playNextFile() {
        let currentIndex = Array.from(fileList).findIndex(a => a.textContent === currentFileName);
        currentIndex++;
        if (currentIndex < fileList.length) {
            playFile(fileList.getElementsByTagName('a')[currentIndex].textContent);
        } else {
            currentIndex = 0;
            playFile(fileList.getElementsByTagName('a')[currentIndex].textContent);
        }
    }

    const startPlaybackButton = document.createElement('button');
    startPlaybackButton.id = 'startPlayback';
    startPlaybackButton.textContent = '最初のファイルを再生';
    document.body.appendChild(startPlaybackButton);


    document.getElementById('startPlayback').addEventListener('click', function() {
        if (fileList.getElementsByTagName('a').length > 0) {
            playFile(fileList.getElementsByTagName('a')[0].textContent);
            this.style.display = 'none';
        }
    });

    // 始めてページ読み込み時にファイル一覧を取得
    fetchFileList();

    // 1分毎にファイル一覧を更新
    setInterval(fetchFileList, 60000);

</script>

</body>
</html>
